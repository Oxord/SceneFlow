import ollama
import json
import logging
from typing import List, Union, Dict, Any

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(name)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

class OllamaClient:
    """
    Клиент для взаимодействия с локальной LLM через Ollama.
    """
    def __init__(self, model_name: str, host: str = "http://localhost:11434"):
        self.model_name = model_name
        self.host = host
        self.client = ollama.Client(host=self.host)
        logger.info(f"OllamaClient initialized with model: {self.model_name}, host: {self.host}")

    def extract_scene_info(self, scene_text: str) -> Dict[str, Any]:
        """
        Отправляет текст сцены в LLM и возвращает извлеченную информацию.
        """
        prompt = f"""
            Ты — высокоточный ассистент для анализа киносценариев. Проанализируй предоставленный фрагмент сценария и извлеки из него информацию строго в формате JSON.
    
            Твои задачи:
            1.  Внимательно прочти текст сцены.
            2.  Извлеки данные для ВСЕХ указанных ниже полей.
            3.  Если информация для какого-то поля отсутствует в тексте, используй значение "N/A" для строк или пустой список [] для списков.
            4.  Твой ответ должен быть полностью на русском языке.
    
            Вот поля для извлечения:
            - "scene_number": (string) номер сцены, как он указан в заголовке (например, "1-1", "1-4-А").
            - "setting": (string) полное описание места и времени действия из заголовка (например, "НАТ. ЛЕС.ПОЛЯНА - НОЧЬ").
            - "location_details": (string) краткое описание локации из ремарок, 1-2 предложения.
            - "characters_present": (list[string]) список имен персонажей, которые ДЕЙСТВУЮТ или ГОВОРЯТ в сцене. Включай только имена людей или живых существ, НЕ неодушевленные предметы. Если персонаж указан в заголовке, но не действует, включи его.
            - "key_events_summary": (string) очень краткое (1-3 предложения) описание ключевых действий и событий в сцене.
            - "emotional_tone": (string) основной эмоциональный тон сцены (например, "напряженный", "трагический", "спокойный", "ироничный").
    
            Сцена для анализа:
            ---
            {scene_text}
            ---
    
            ВАЖНО: Твой ответ должен быть ИСКЛЮЧИТЕЛЬНО валидным JSON-объектом на русском языке. Не добавляй никаких пояснений, вступлений или комментариев до или после JSON.
            """
        try:
            # Используем ollama.chat для лучшего контроля и поддержки 'json' формата
            response = self.client.chat(
                model=self.model_name,
                messages=[{'role': 'user', 'content': prompt}],
                format='json', # Указываем, что ожидаем JSON-ответ
                options={
                    'temperature': 0.1 # Делаем ответы более детерминированными
                },
            )
            llm_content = response['message']['content']
            return json.loads(llm_content)
        except json.JSONDecodeError as e:
            logger.error(f"Ошибка декодирования JSON от LLM: {e}")
            logger.error(f"Сырой ответ LLM: {llm_content}")
            return {"error": "JSONDecodeError", "message": str(e), "raw_llm_response": llm_content}
        except Exception as e:
            logger.error(f"Ошибка при запросе к Ollama: {e}")
            return {"error": "OllamaRequestError", "message": str(e)}

    def generate_production_details(self, scene_summary: str, scene_text: str) -> Dict[str, Any]:
        """
        На основе описания сцены генерирует производственные детали.
        """
        prompt = f"""
            Ты — скрупулезный и педантичный ассистент режиссера по подготовке съемок. Твоя задача — строго на основе предоставленного текста сценария составить список производственных требований.
    
            ОБЯЗАТЕЛЬНЫЕ ПРАВИЛА:
            1.  НЕ ДОДУМЫВАЙ: Если информация отсутствует в тексте — не придумывай ее. Используй "N/A" или [].
            2.  НЕ ИНТЕРПРЕТИРУЙ МЕТАФОРЫ БУКВАЛЬНО: Сравнения (например, "как дед из памятника Хатынь") — это литературный прием, а не описание реального объекта или персонажа.
            3.  ОТВЕЧАЙ ИСКЛЮЧИТЕЛЬНО НА РУССКОМ ЯЗЫКЕ: Весь твой вывод должен быть на русском. Никаких английских или других слов.
            4.  ФОРМАТ: Ответ должен быть ТОЛЬКО валидным JSON без каких-либо комментариев.
    
            Проанализируй полный текст сцены и краткое содержание, чтобы заполнить следующие поля:
    
            Краткое содержание сцены:
            ---
            {scene_summary}
            ---
    
            Полный текст сцены для анализа:
            ---
            {scene_text}
            ---
    
            Заполни следующий JSON-объект:
            - "costume": (string) Описание одежды, которая конкретно УПОМЯНУТА в тексте (например, "мокрый и грязный", "одежда испачкана"). Не пиши "обычная одежда", если это не указано.
            - "makeup_and_hair": (string) Описание грима и причесок, если они явно описаны. Указывай только то, что требует работы гримера (например, "кровь на лице и руках", "длинные седые волосы взрослого").
            - "props": (list[string]) Список ПРЕДМЕТОВ, с которыми персонажи активно взаимодействуют (держат в руках, используют). НЕ ВКЛЮЧАЙ животных, транспорт или крупные элементы декораций (мебель, раковины). Пример: ["бинокль", "бутылка пива", "блокнот"].
            - "extras": (string) Описание массовки, только если она ЯВНО УПОМЯНУТА в тексте (например, "прохожие", "посетители кафе").
            - "stunts": (string) Описание профессиональных трюков, требующих подготовки или каскадера (например, "драка", "падение с высоты"). НЕ СЧИТАЙ трюком обычные действия, такие как бег или плач.
            - "special_effects": (string) Описание визуальных эффектов, которые создаются на площадке или пост-продакшене (например, "эффект дождя", "дым", "брызги крови"). НЕ ВКЛЮЧАЙ звуковые эффекты.
            - "music": (string) Описание музыки или значимых звуков, если они прямо упомянуты в тексте (например, "музыка из телевизора", "шум работающего миксера").
        """

        try:
            response = self.client.chat(
                model=self.model_name,
                messages=[{'role': 'user', 'content': prompt}],
                format='json',
                options={'temperature': 0.2}
            )
            llm_content = response['message']['content']
            return json.loads(llm_content)
        except json.JSONDecodeError as e:
            logger.error(f"Ошибка декодирования JSON для production_details: {e}")
            return {}
        except Exception as e:
            logger.error(f"Ошибка при запросе к Ollama для production_details: {e}")
            return {}